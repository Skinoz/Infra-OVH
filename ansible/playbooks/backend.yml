---
- name: Configuration du serveur Backend API
  hosts: all
  become: yes
  vars:
    backend_version: "{{ backend_version | default('1.0') }}"
    node_version: "20.x"
  
  tasks:
    - name: Nettoyer les fichiers cloud-init
      file:
        path: /var/lib/cloud/
        state: absent

    - name: Nettoyer cloud-init
      command: cloud-init clean
      ignore_errors: yes

    - name: Installer les dépendances système
      apt:
        name:
          - curl
          - gnupg
          - ca-certificates
        state: present
        update_cache: yes

    - name: Ajouter la clé GPG NodeSource
      shell: |
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
      args:
        creates: /usr/share/keyrings/nodesource.gpg

    - name: Ajouter le repository NodeSource
      shell: |
        echo "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ node_version }} nodistro main" > /etc/apt/sources.list.d/nodesource.list

    - name: Installer Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes

    - name: Créer le répertoire de l'application
      file:
        path: /opt/backend-api
        state: directory
        owner: debian
        group: debian
        mode: '0755'

    - name: Copier l'application backend
      template:
        src: ../templates/backend-api.js.j2
        dest: /opt/backend-api/server.js
        owner: debian
        group: debian
        mode: '0644'

    - name: Créer package.json
      copy:
        content: |
          {
            "name": "backend-api",
            "version": "{{ backend_version }}",
            "description": "Backend API Server",
            "main": "server.js",
            "scripts": {
              "start": "node server.js"
            },
            "dependencies": {
              "express": "^4.18.2",
              "cors": "^2.8.5",
              "pg": "^8.11.3",
              "dotenv": "^16.3.1"
            }
          }
        dest: /opt/backend-api/package.json
        owner: debian
        group: debian
        mode: '0644'

    - name: Créer le fichier .env par défaut
      copy:
        content: |
          DATABASE_HOST=localhost
          DATABASE_PORT=5432
          DATABASE_NAME=appdb
          DATABASE_USER=appuser
          DATABASE_PASSWORD=changeme123
        dest: /opt/backend-api/.env
        owner: debian
        group: debian
        mode: '0600'

    - name: Installer les dépendances npm
      command: npm install
      args:
        chdir: /opt/backend-api
      become_user: debian

    - name: Créer le service systemd
      copy:
        content: |
          [Unit]
          Description=Backend API Server
          After=network.target

          [Service]
          Type=simple
          User=debian
          WorkingDirectory=/opt/backend-api
          ExecStart=/usr/bin/node /opt/backend-api/server.js
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=backend-api
          Environment=NODE_ENV=production
          Environment=PORT=3000

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/backend-api.service
        owner: root
        group: root
        mode: '0644'

    - name: Recharger systemd
      systemd:
        daemon_reload: yes

    - name: Activer et démarrer le service backend-api
      systemd:
        name: backend-api
        enabled: yes
        state: started
